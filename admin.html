<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Coinel — Admin de asignaciones</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://esm.sh">
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:#0b0d12; color:#e5e7eb; }
    header { display:flex; gap:12px; align-items:center; padding:14px 18px; border-bottom:1px solid #1f2937;}
    header h1 { font-size:18px; margin:0; font-weight:600;}
    .wrap { max-width:1100px; margin:24px auto; padding:0 20px;}
    .card { background:#121521; border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.3); }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width: 1024px){ .grid { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size:12px; color:#9ca3af; margin-bottom:6px; }
    input, select, button { background:#0e1220; color:#e5e7eb; border:1px solid #243045; border-radius:10px; padding:10px 12px; }
    button { cursor:pointer; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:#9ca3af; font-size:12px; }
    .hide { display:none; }
    table { width:100%; border-collapse: collapse; font-size:13px;}
    th, td { padding:8px 10px; border-bottom:1px solid #1f2937; text-align:left; vertical-align: top; }
    .badge { display:inline-block; padding:2px 8px; border:1px solid #334155; border-radius:999px; font-size:12px; }
    .ok { color:#22c55e; }
    .err { color:#ef4444; }
    .btn-secondary { background:#0b1324; border-color:#1f2a44; }
    .section-title { margin:0 0 8px 0; font-size:14px; }
    code { background:#0b1324; padding:1px 6px; border-radius:6px; border:1px solid #1f2a44; }
  </style>
</head>
<body>
<header>
  <h1>Coinel — Admin de asignaciones</h1>
  <div style="margin-left:auto" class="row">
    <span id="who" class="muted"></span>
    <button id="logoutBtn" class="hide">Cerrar sesión</button>
  </div>
</header>

<div class="wrap">

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3 style="margin:0 0 10px 0">Iniciar sesión</h3>
    <div class="row">
      <div>
        <label>Email</label>
        <input id="email" type="email" placeholder="email@dominio.com" />
      </div>
      <div>
        <label>Contraseña</label>
        <input id="password" type="password" placeholder="••••••••" />
      </div>
      <div style="align-self:end">
        <button id="loginBtn">Entrar</button>
      </div>
    </div>
    <p class="muted" style="margin-top:8px">Esta consola requiere un usuario con rol de <strong>administrador</strong> para asignar accesos. Inicia sesión con tu cuenta.</p>
    <div id="loginMsg" class="muted" style="min-height:18px"></div>
  </div>

  <!-- ADMIN -->
  <div id="adminCard" class="hide">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">Panel de administrador</h3>
        <span id="adminBadge" class="badge">Verificando rol…</span>
      </div>

      <!-- Admin Secret -->
      <div class="row" style="margin-top:10px">
        <div>
          <label>Admin Secret (x-admin-secret)</label>
          <input id="adminSecretInput" type="password" placeholder="pegar secreto de admin" style="min-width:280px" />
        </div>
        <button id="saveSecretBtn" class="btn-secondary" style="align-self:end">Guardar secreto</button>
        <span id="secretMsg" class="muted"></span>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="reloadBtn" class="btn-secondary">Recargar lista</button>
        <span id="globalMsg" class="muted"></span>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">

      <!-- Crear dispositivo (del usuario actual) -->
      <div class="card">
        <h4 class="section-title">Crear dispositivo propio</h4>
        <div class="row">
          <div>
            <label>Nombre</label>
            <input id="newDeviceName" type="text" placeholder="Ej: ESP32 Sala" style="min-width:280px" />
          </div>
          <button id="createDeviceBtn" style="align-self:end">Crear</button>
        </div>
        <div id="createMsg" class="muted" style="margin-top:8px"></div>
      </div>

      <!-- Asignar / cambiar rol / revocar -->
      <div class="card">
        <h4 class="section-title">Asignar/cambiar acceso (requiere Admin Secret)</h4>
        <div class="row">
          <div style="min-width:260px">
            <label>Dispositivo</label>
            <select id="deviceSelect"></select>
          </div>
          <div>
            <label>User ID (UID del usuario)</label>
            <input id="userIdInput" type="text" placeholder="uuid del usuario" style="min-width:280px" />
          </div>
          <div>
            <label>Rol</label>
            <select id="roleSelect">
              <option value="viewer" selected>viewer</option>
              <option value="editor">editor</option>
              <option value="owner">owner</option>
            </select>
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="assignBtn">Asignar / Actualizar rol</button>
          <button id="revokeBtn" class="btn-secondary">Revocar acceso</button>
          <span class="muted">El secreto se manda en header <code>x-admin-secret</code>.</span>
        </div>
        <div id="assignMsg" class="muted" style="margin-top:8px"></div>
      </div>

    </div>

    <!-- Tabla de mis asignaciones -->
    <div class="card" style="margin-top:16px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h4 class="section-title" style="margin:0">Mis asignaciones</h4>
        <div class="row">
          <label class="muted">Filtrar por texto</label>
          <input id="filterInput" type="text" placeholder="device_id, nombre, rol…" />
        </div>
      </div>
      <table style="margin-top:10px">
        <thead>
          <tr>
            <th>Device</th>
            <th>Device ID</th>
            <th>Owner ID</th>
            <th>Mi rol</th>
            <th>Estado</th>
            <th>Creado</th>
            <th>Acciones (si soy owner)</th>
          </tr>
        </thead>
        <tbody id="assignBody"></tbody>
      </table>
      <div id="tableMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

</div>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ====== CONFIG ======
  const SUPABASE_URL = "https://beieykwfmsbodfzxijkz.supabase.co";
  const SUPABASE_ANON_KEY = "TU_ANON_PUBLIC_AQUI"; // ⚠️ reemplazar
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Edge Function base (según tu servidor)
  const FUNC_BASE = `${SUPABASE_URL}/functions/v1/device-access-api`; // GET/POST '', GET/PATCH/DELETE ':id', POST ':id/assign'

  // ====== UI refs ======
  const loginCard = document.getElementById("loginCard");
  const adminCard = document.getElementById("adminCard");
  const who = document.getElementById("who");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginBtn = document.getElementById("loginBtn");
  const loginMsg = document.getElementById("loginMsg");
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");

  const adminBadge = document.getElementById("adminBadge");
  const reloadBtn = document.getElementById("reloadBtn");
  const globalMsg = document.getElementById("globalMsg");

  const adminSecretInput = document.getElementById("adminSecretInput");
  const saveSecretBtn = document.getElementById("saveSecretBtn");
  const secretMsg = document.getElementById("secretMsg");

  const newDeviceName = document.getElementById("newDeviceName");
  const createDeviceBtn = document.getElementById("createDeviceBtn");
  const createMsg = document.getElementById("createMsg");

  const deviceSelect = document.getElementById("deviceSelect");
  const userIdInput = document.getElementById("userIdInput");
  const roleSelect = document.getElementById("roleSelect");
  const assignBtn = document.getElementById("assignBtn");
  const revokeBtn = document.getElementById("revokeBtn");
  const assignMsg = document.getElementById("assignMsg");

  const filterInput = document.getElementById("filterInput");
  const assignBody = document.getElementById("assignBody");
  const tableMsg = document.getElementById("tableMsg");

  // ====== helpers ======
  const getSession = async () => (await supabase.auth.getSession()).data.session;

  const getAuthHeaders = async () => {
    const session = await getSession();
    if (!session) throw new Error("No hay sesión");
    return { "Authorization": `Bearer ${session.access_token}`, "Content-Type": "application/json" };
  };

  const callAPI = async (path, method = "GET", body = undefined, asAdmin = false) => {
    const headers = await getAuthHeaders();
    if (asAdmin) {
      const secret = (localStorage.getItem("adminSecret") || "").trim();
      if (!secret) throw new Error("Falta Admin Secret");
      headers["x-admin-secret"] = secret;
    }
    const res = await fetch(`${FUNC_BASE}${path}`, {
      method,
      headers,
      body: body ? JSON.stringify(body) : undefined
    });
    const text = await res.text();
    let json = {};
    try { json = text ? JSON.parse(text) : {}; } catch { json = { raw: text }; }
    if (!res.ok) throw new Error(json?.error || `HTTP ${res.status}`);
    return json;
  };

  const showLogin = () => {
    adminCard.classList.add("hide");
    loginCard.classList.remove("hide");
    logoutBtn.classList.add("hide");
    who.textContent = "";
  };

  const showAdmin = (user) => {
    loginCard.classList.add("hide");
    adminCard.classList.remove("hide");
    logoutBtn.classList.remove("hide");
    who.textContent = user?.email ?? "";
  };

  // ¿Es admin? — lo inferimos intentando leer en tabla admins (RLS: user_id = auth.uid())
  const checkIsAdmin = async (userId) => {
    try {
      const { data, error } = await supabase
        .from("admins")
        .select("user_id")
        .eq("user_id", userId)
        .single();
      return !!(data && !error);
    } catch { return false; }
  };

  // Rellena selects de dispositivos usando mis asignaciones (lo que devuelve la función)
  const populateDevicesFromRows = (rows) => {
    deviceSelect.innerHTML = "";
    const seen = new Set();
    for (const r of rows) {
      const dev = r.devices || {};
      const id = dev.id || r.device_id;
      if (!id || seen.has(id)) continue;
      seen.add(id);
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = dev.name || id;
      deviceSelect.appendChild(opt);
    }
  };

  // Render de mis asignaciones (lista)
  const renderAssignments = async () => {
    assignBody.innerHTML = "";
    tableMsg.textContent = "Cargando…";
    try {
      // GET '' -> devuelve array simple de device_access con join devices(*)
      const rows = await callAPI("", "GET");
      if (!Array.isArray(rows) || rows.length === 0) {
        tableMsg.textContent = "No hay asignaciones.";
        populateDevicesFromRows([]);
        return;
      }
      tableMsg.textContent = "";
      populateDevicesFromRows(rows);

      // Saber mi user_id para decidir acciones (owner)
      const me = (await supabase.auth.getUser()).data.user;
      const myId = me?.id;

      for (const r of rows) {
        const dev = r.devices || {};
        const isOwner = (r.role === "owner") || (dev.user_id && dev.user_id === myId);
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${dev.name ?? "(s/n)"} </td>
          <td><code>${dev.id ?? r.device_id}</code></td>
          <td><code>${dev.user_id ?? ""}</code></td>
          <td>${r.role}</td>
          <td>${r.is_active ? "activo" : "inactivo"}</td>
          <td>${new Date(dev.created_at || r.created_at || Date.now()).toLocaleString()}</td>
          <td>
            ${
              isOwner ? `
                <div class="row" style="gap:6px;">
                  <input data-act="rename" data-id="${dev.id ?? r.device_id}" placeholder="nuevo nombre" />
                  <button data-act="doRename" data-id="${dev.id ?? r.device_id}" class="btn-secondary">Renombrar</button>
                  <button data-act="delete" data-id="${dev.id ?? r.device_id}">Eliminar</button>
                </div>
              ` : `<span class="muted">—</span>`
            }
          </td>
        `;
        assignBody.appendChild(tr);
      }

      // wire acciones owner
      assignBody.querySelectorAll('button[data-act="doRename"]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-id");
          const input = assignBody.querySelector(`input[data-act="rename"][data-id="${id}"]`);
          const name = (input?.value || "").trim();
          if (!name) return alert("Ingresa un nuevo nombre");
          try {
            await callAPI(`/${id}`, "PATCH", { name });
            btn.textContent = "Renombrado ✓";
            setTimeout(()=> btn.textContent = "Renombrar", 1000);
            await renderAssignments();
          } catch (e) {
            alert("Error al renombrar: " + e.message);
          }
        };
      });
      assignBody.querySelectorAll('button[data-act="delete"]').forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-id");
          if (!confirm("¿Eliminar dispositivo? Esto borra el registro del dispositivo.")) return;
          try {
            await callAPI(`/${id}`, "DELETE");
            btn.textContent = "Eliminado ✓";
            await renderAssignments();
          } catch (e) {
            alert("Error al eliminar: " + e.message);
          }
        };
      });

      // filtro rápido
      filterInput.oninput = () => {
        const q = filterInput.value.trim().toLowerCase();
        assignBody.querySelectorAll("tr").forEach(tr => {
          const txt = tr.innerText.toLowerCase();
          tr.style.display = txt.includes(q) ? "" : "none";
        });
      };

    } catch (e) {
      tableMsg.textContent = "Error: " + e.message;
    }
  };

  // ====== bootstrap / flujo ======
  const checkAdminAndInit = async () => {
    const session = await getSession();
    if (!session) { showLogin(); return; }
    const user = (await supabase.auth.getUser()).data?.user ?? null;

    // ¿es admin?
    adminBadge.textContent = "Comprobando…";
    const isAdmin = user ? await checkIsAdmin(user.id) : false;
    adminBadge.textContent = isAdmin ? "Superadmin" : "Usuario";

    // precargar admin secret si lo hay
    const saved = localStorage.getItem("adminSecret") || "";
    if (saved) adminSecretInput.value = saved;

    showAdmin(user);
    await renderAssignments();
  };

  // ====== eventos ======
  loginBtn.onclick = async () => {
    loginMsg.textContent = "";
    const { error } = await supabase.auth.signInWithPassword({
      email: emailEl.value.trim(),
      password: passEl.value.trim()
    });
    if (error) {
      loginMsg.textContent = "Error: " + error.message;
      loginMsg.className = "err";
      return;
    }
    await checkAdminAndInit();
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    showLogin();
  };

  reloadBtn.onclick = renderAssignments;

  saveSecretBtn.onclick = () => {
    const v = (adminSecretInput.value || "").trim();
    if (!v) { secretMsg.textContent = "Secreto vacío"; secretMsg.className = "err"; return; }
    localStorage.setItem("adminSecret", v);
    secretMsg.textContent = "Secreto guardado en este navegador.";
    secretMsg.className = "ok";
    setTimeout(()=> secretMsg.textContent = "", 1500);
  };

  createDeviceBtn.onclick = async () => {
    createMsg.textContent = "";
    const name = (newDeviceName.value || "").trim();
    if (!name) { createMsg.textContent = "Ingresa un nombre"; createMsg.className = "err"; return; }
    try {
      await callAPI("", "POST", { name });
      createMsg.textContent = "Dispositivo creado.";
      createMsg.className = "ok";
      newDeviceName.value = "";
      await renderAssignments();
    } catch (e) {
      createMsg.textContent = "Error: " + e.message;
      createMsg.className = "err";
    }
  };

  assignBtn.onclick = async () => {
    assignMsg.textContent = "";
    const device_id = deviceSelect.value;
    const user_id = userIdInput.value.trim();
    const role = roleSelect.value;
    if (!device_id || !user_id) {
      assignMsg.textContent = "Completa dispositivo y user_id";
      assignMsg.className = "err";
      return;
    }
    try {
      await callAPI(`/${device_id}/assign`, "POST", { user_id, role, is_active: true }, true);
      assignMsg.textContent = "Asignación/rol aplicado.";
      assignMsg.className = "ok";
      userIdInput.value = "";
      await renderAssignments();
    } catch (e) {
      assignMsg.textContent = "Error: " + e.message;
      assignMsg.className = "err";
    }
  };

  revokeBtn.onclick = async () => {
    assignMsg.textContent = "";
    const device_id = deviceSelect.value;
    const user_id = userIdInput.value.trim();
    if (!device_id || !user_id) {
      assignMsg.textContent = "Completa dispositivo y user_id";
      assignMsg.className = "err";
      return;
    }
    if (!confirm("¿Seguro que quieres revocar este acceso?")) return;
    try {
      await callAPI(`/${device_id}/assign`, "POST", { user_id, is_active: false }, true);
      assignMsg.textContent = "Acceso revocado.";
      assignMsg.className = "ok";
      await renderAssignments();
    } catch (e) {
      assignMsg.textContent = "Error: " + e.message;
      assignMsg.className = "err";
    }
  };

  // Auto-bootstrap
  (async () => {
    const session = await getSession();
    if (session) await checkAdminAndInit(); else showLogin();
  })();
</script>
</body>
</html>
