<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Coinel — Telemetría</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://esm.sh">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans"; background:#0b0d12; color:#e5e7eb; }
    header { display:flex; gap:12px; align-items:center; padding:16px 20px; border-bottom:1px solid #1f2937;}
    header h1 { font-size:18px; margin:0; font-weight:600;}
    .wrap { max-width:1100px; margin:24px auto; padding:0 20px;}
    .card { background:#121521; border:1px solid #1f2937; border-radius:16px; padding:16px; box-shadow:0 8px 20px rgba(0,0,0,.3); }
    .grid { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width: 900px){ .grid { grid-template-columns: 1.2fr .8fr; } }
    label { display:block; font-size:12px; color:#9ca3af; margin-bottom:6px; }
    input, select, button { background:#0e1220; color:#e5e7eb; border:1px solid #243045; border-radius:10px; padding:10px 12px; }
    button { cursor:pointer; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    table { width:100%; border-collapse: collapse; font-size:13px;}
    th, td { padding:8px 10px; border-bottom:1px solid #1f2937; text-align:left; }
    .muted { color:#9ca3af; font-size:12px; }
    .hide { display:none; }
    .links { display:flex; gap:12px; margin-top:12px; }
    .links a { color:#93c5fd; font-size:12px; text-decoration:none; cursor:pointer; }
    .links a:hover { text-decoration:underline; }
    .btn-secondary { background:#0b1324; border-color:#1f2a44; }
    .success { color:#34d399; }
    .error { color:#f87171; }

    /* Aviso amable post-signup */
    .notice { background:#0e1528; border:1px solid #1f2a44; border-radius:12px; padding:12px 14px; margin-top:12px; }
    .steps { margin:10px 0 0 0; padding-left:18px; color:#cbd5e1; }
    .steps li { margin:6px 0; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #334155; color:#93c5fd; font-size:12px; }
  </style>
</head>
<body>
<header>
  <h1>Coinel — Telemetría (Supabase)</h1>
  <div style="margin-left:auto" class="row">
    <span id="userEmail" class="muted"></span>
    <button id="logoutBtn" class="hide">Cerrar sesión</button>
  </div>
</header>

<div class="wrap">

  <!-- AUTH -->
  <div id="loginCard" class="card">
    <h3 id="authTitle" style="margin-top:0">Iniciar sesión</h3>

    <!-- Login -->
    <div id="view-login">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="email" type="email" placeholder="email@dominio.com" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="password" type="password" placeholder="••••••••" />
        </div>
        <div style="align-self:end">
          <button id="loginBtn">Entrar</button>
        </div>
      </div>
    </div>

    <!-- Sign up -->
    <div id="view-signup" class="hide">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="suEmail" type="email" placeholder="email@dominio.com" />
        </div>
        <div>
          <label>Contraseña</label>
          <input id="suPass1" type="password" placeholder="mín. 6 caracteres" />
        </div>
        <div>
          <label>Repite contraseña</label>
          <input id="suPass2" type="password" placeholder="••••••••" />
        </div>
        <div style="align-self:end">
          <button id="signupBtn">Crear cuenta</button>
        </div>
      </div>
      <p class="muted">Te enviaremos un email para confirmar tu cuenta.</p>
    </div>

    <!-- Resend confirmation -->
    <div id="view-resend" class="hide">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="rsEmail" type="email" placeholder="email@dominio.com" />
        </div>
        <div style="align-self:end">
          <button id="resendBtn">Reenviar confirmación</button>
        </div>
      </div>
    </div>

    <!-- Request reset -->
    <div id="view-forgot" class="hide">
      <div class="row">
        <div>
          <label>Email</label>
          <input id="fgEmail" type="email" placeholder="email@dominio.com" />
        </div>
        <div style="align-self:end">
          <button id="forgotBtn">Enviar enlace de recuperación</button>
        </div>
      </div>
      <p class="muted">Revisa tu correo y sigue el enlace para establecer una nueva contraseña.</p>
    </div>

    <!-- Set new password (after email link) -->
    <div id="view-recovery" class="hide">
      <div class="row">
        <div>
          <label>Nueva contraseña</label>
          <input id="rcPass1" type="password" placeholder="nueva contraseña" />
        </div>
        <div>
          <label>Repetir contraseña</label>
          <input id="rcPass2" type="password" placeholder="••••••••" />
        </div>
        <div style="align-self:end">
          <button id="recoveryBtn">Guardar contraseña</button>
        </div>
      </div>
    </div>

    <!-- Check email (friendly) -->
    <div id="view-check" class="hide">
      <div class="notice">
        <div><span class="pill">Paso siguiente</span></div>
        <p style="margin:8px 0 0 0">
          Te enviamos un correo de <strong>confirmación</strong> a <strong id="checkEmail"></strong>.
        </p>
        <ul class="steps">
          <li>Abre el email y haz clic en <em>Confirmar</em>.</li>
          <li>Al confirmar, regresa e <strong>inicia sesión</strong>.</li>
          <li>Verás los <strong>dispositivos</strong> a los que tienes acceso.</li>
        </ul>
        <div class="row" style="margin-top:10px">
          <button id="openInboxBtn" class="btn-secondary">Abrir mi correo</button>
          <button id="resendConfirmBtn">Reenviar confirmación</button>
          <a id="changeEmailLink" class="muted" style="margin-left:8px; cursor:pointer">Cambiar email</a>
        </div>
      </div>
    </div>

    <div id="loginError" class="muted" style="min-height:18px"></div>

    <div class="links">
      <a id="linkLogin">Iniciar sesión</a>
      <a id="linkSignup">Crear cuenta</a>
      <a id="linkResend">Reenviar confirmación</a>
      <a id="linkForgot">Olvidé mi contraseña</a>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dash" class="hide">
    <div class="card">
      <div class="row">
        <div style="min-width:260px">
          <label>Dispositivo</label>
          <select id="deviceSelect"></select>
        </div>
        <div>
          <label>Rango</label>
          <select id="rangeSelect">
            <option value="1h">Última 1h</option>
            <option value="6h" selected>Últimas 6h</option>
            <option value="24h">Últimas 24h</option>
            <option value="7d">Últimos 7 días</option>
          </select>
        </div>
        <button id="refreshBtn" class="btn-secondary" style="align-self:end">Actualizar</button>
        <span class="muted" id="liveStatus">Auto: off</span>
      </div>
    </div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <canvas id="chart" height="140"></canvas>
      </div>
      <div class="card">
        <h4 style="margin:0 0 8px 0">Lecturas recientes</h4>
        <table>
          <thead><tr><th>Fecha</th><th>Temp</th><th>Hum</th><th>JSON</th></tr></thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<!-- APP -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ======= CONFIG: TU PROYECTO =======
  const SUPABASE_URL = "https://beieykwfmsbodfzxijkz.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJlaWV5a3dmbXNib2Rmenhpamt6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyNTY1MTQsImV4cCI6MjA3NDgzMjUxNH0.8GDXx1DFM0177URNRq5VDtr7RtGwcKOiXszwn7Hpl9Y";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const REDIRECT_TO = location.origin + location.pathname; // vuelve a esta misma página

  // ======= UI refs =======
  const loginCard = document.getElementById("loginCard");
  const authTitle = document.getElementById("authTitle");
  const dash = document.getElementById("dash");
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");
  const loginErr = document.getElementById("loginError");
  const userEmail = document.getElementById("userEmail");
  const logoutBtn = document.getElementById("logoutBtn");
  const deviceSelect = document.getElementById("deviceSelect");
  const rangeSelect = document.getElementById("rangeSelect");
  const refreshBtn = document.getElementById("refreshBtn");
  const rowsBody = document.getElementById("rows");
  const liveStatus = document.getElementById("liveStatus");

  const vLogin   = document.getElementById("view-login");
  const vSignup  = document.getElementById("view-signup");
  const vResend  = document.getElementById("view-resend");
  const vForgot  = document.getElementById("view-forgot");
  const vRecover = document.getElementById("view-recovery");
  const vCheck   = document.getElementById("view-check");

  const suEmail  = document.getElementById("suEmail");
  const suPass1  = document.getElementById("suPass1");
  const suPass2  = document.getElementById("suPass2");
  const signupBtn= document.getElementById("signupBtn");

  const rsEmail  = document.getElementById("rsEmail");
  const resendBtn= document.getElementById("resendBtn");

  const fgEmail  = document.getElementById("fgEmail");
  const forgotBtn= document.getElementById("forgotBtn");

  const rcPass1  = document.getElementById("rcPass1");
  const rcPass2  = document.getElementById("rcPass2");
  const recoveryBtn = document.getElementById("recoveryBtn");

  const linkLogin  = document.getElementById("linkLogin");
  const linkSignup = document.getElementById("linkSignup");
  const linkResend = document.getElementById("linkResend");
  const linkForgot = document.getElementById("linkForgot");

  const checkEmail = document.getElementById("checkEmail");
  const openInboxBtn = document.getElementById("openInboxBtn");
  const resendConfirmBtn = document.getElementById("resendConfirmBtn");
  const changeEmailLink = document.getElementById("changeEmailLink");

  let lastSignupEmail = "";

  // ======= helpers UI auth =======
  function setAuthView(which) {
    vLogin.classList.toggle("hide",   which !== "login");
    vSignup.classList.toggle("hide",  which !== "signup");
    vResend.classList.toggle("hide",  which !== "resend");
    vForgot.classList.toggle("hide",  which !== "forgot");
    vRecover.classList.toggle("hide", which !== "recovery");
    vCheck.classList.toggle("hide",   which !== "check");
    authTitle.textContent =
      which === "signup"   ? "Crear cuenta" :
      which === "resend"   ? "Reenviar confirmación" :
      which === "forgot"   ? "Recuperar contraseña" :
      which === "recovery" ? "Establecer nueva contraseña" :
      which === "check"    ? "Revisa tu correo" :
                             "Iniciar sesión";
    loginErr.textContent = "";
    loginErr.className = "muted";
  }

  linkLogin.onclick  = () => setAuthView("login");
  linkSignup.onclick = () => setAuthView("signup");
  linkResend.onclick = () => setAuthView("resend");
  linkForgot.onclick = () => setAuthView("forgot");

  changeEmailLink.onclick = () => {
    suEmail.value = lastSignupEmail;
    setAuthView("signup");
  };

  openInboxBtn.onclick = () => {
    const email = (checkEmail.textContent || lastSignupEmail || "").trim().toLowerCase();
    const domain = email.split("@")[1] || "";
    let url = "about:blank";
    if (domain.includes("gmail.com")) url = "https://mail.google.com/";
    else if (domain.includes("outlook.") || domain.includes("hotmail.") || domain.includes("live.")) url = "https://outlook.live.com/";
    else if (domain.includes("yahoo.")) url = "https://mail.yahoo.com/";
    else url = "https://"+domain; // mejor esfuerzo
    window.open(url, "_blank");
  };

  resendConfirmBtn.onclick = async () => {
    const email = lastSignupEmail || rsEmail.value.trim();
    if (!email) {
      loginErr.textContent = "No tenemos un email para reenviar. Vuelve a 'Crear cuenta' o usa 'Reenviar confirmación'.";
      loginErr.className = "error";
      return;
    }
    const { error } = await supabase.auth.resend({
      type: "signup",
      email,
      options: { emailRedirectTo: REDIRECT_TO }
    });
    if (error) {
      loginErr.textContent = "Error al reenviar: " + error.message;
      loginErr.className = "error";
      return;
    }
    loginErr.textContent = "Te reenviamos el correo de confirmación.";
    loginErr.className = "success";
  };

  // ======= Chart =======
  let chart;
  function ensureChart() {
    if (chart) return chart;
    const ctx = document.getElementById("chart").getContext("2d");
    chart = new window.Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [
        { label: "Temp", data: [], yAxisID: 'y' },
        { label: "Hum",  data: [], yAxisID: 'y1' }
      ]},
      options: {
        responsive: true,
        interaction: { intersect: false, mode: 'index' },
        scales: {
          x: { ticks: { maxRotation:0, autoSkip: true }},
          y: { position:'left' },
          y1:{ position:'right', grid:{ drawOnChartArea:false } }
        },
        plugins: { legend: { position:'bottom' } }
      }
    });
    return chart;
  }

  // ======= Polling cada 10 s =======
  let pollTimer = null;
  let lastTsISO = null;
  const seenIds = new Set();
  const POLL_MS = 10_000;

  function stopAuto() {
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = null;
    liveStatus.textContent = "Auto: off";
  }
  function startAuto(deviceId) {
    stopAuto();
    liveStatus.textContent = "Auto: 10s";
    fetchNew(deviceId).catch(console.error);
    pollTimer = setInterval(() => fetchNew(deviceId).catch(console.error), POLL_MS);
  }
  async function fetchNew(deviceId) {
    if (!lastTsISO) return;
    const { data, error } = await supabase
      .from("readings").select("id, ts, data")
      .eq("device_id", deviceId).gt("ts", lastTsISO)
      .order("ts", { ascending: true }).limit(1000);
    if (error) { console.error(error); return; }
    if (!data?.length) return;

    const c = ensureChart();
    for (const r of data) {
      if (seenIds.has(r.id)) continue;
      seenIds.add(r.id);
      const tsLabel = new Date(r.ts).toLocaleString();
      const temp = r.data?.temp ?? r.data?.t ?? null;
      const hum  = r.data?.hum  ?? r.data?.h ?? null;
      c.data.labels.push(tsLabel);
      c.data.datasets[0].data.push(temp);
      c.data.datasets[1].data.push(hum);

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${tsLabel}</td>
                      <td>${temp ?? "-"}</td>
                      <td>${hum ?? "-"}</td>
                      <td class="muted">${JSON.stringify(r.data)}</td>`;
      rowsBody.insertBefore(tr, rowsBody.firstChild);
    }
    lastTsISO = data[data.length - 1].ts;

    const MAX_POINTS = 500;
    while (c.data.labels.length > MAX_POINTS) {
      c.data.labels.shift();
      c.data.datasets[0].data.shift();
      c.data.datasets[1].data.shift();
    }
    c.update();
  }

  // ======= Data =======
  async function loadDevices() {
    const { data, error } = await supabase
      .from("devices").select("*")
      .order("created_at", { ascending: false });
    if (error) throw error;
    deviceSelect.innerHTML = "";
    if (!data?.length) {
      deviceSelect.innerHTML = '<option value="">(sin dispositivos)</option>';
      return;
    }
    for (const d of data) {
      const opt = document.createElement("option");
      opt.value = d.id;
      opt.textContent = d.name || d.id;
      deviceSelect.appendChild(opt);
    }
  }

  function rangeToISO(range) {
    const now = new Date();
    const from = new Date(now);
    if (range === "1h") from.setHours(now.getHours()-1);
    if (range === "6h") from.setHours(now.getHours()-6);
    if (range === "24h") from.setDate(now.getDate()-1);
    if (range === "7d") from.setDate(now.getDate()-7);
    return from.toISOString();
  }

  async function loadHistory(deviceId) {
    const fromISO = rangeToISO(rangeSelect.value);
    const { data, error } = await supabase
      .from("readings").select("id, ts, data")
      .eq("device_id", deviceId)
      .gte("ts", fromISO)
      .order("ts", { ascending: true })
      .limit(5000);
    if (error) throw error;

    const c = ensureChart();
    c.data.labels = [];
    c.data.datasets[0].data = [];
    c.data.datasets[1].data = [];
    rowsBody.innerHTML = "";
    seenIds.clear();

    for (const r of data) {
      seenIds.add(r.id);
      const tsLabel = new Date(r.ts).toLocaleString();
      const temp = r.data?.temp ?? r.data?.t ?? null;
      const hum  = r.data?.hum  ?? r.data?.h ?? null;
      c.data.datasets[0].data.push(temp);
      c.data.datasets[1].data.push(hum);
      c.data.labels.push(tsLabel);

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${tsLabel}</td>
                      <td>${temp ?? "-"}</td>
                      <td>${hum ?? "-"}</td>
                      <td class="muted">${JSON.stringify(r.data)}</td>`;
      rowsBody.appendChild(tr);
    }
    c.update();
    lastTsISO = (data && data.length) ? data[data.length - 1].ts : fromISO;
  }

  // ======= Auth & flujo =======
  async function showApp() {
    loginCard.classList.add("hide");
    dash.classList.remove("hide");
    const { data: { user } } = await supabase.auth.getUser();
    userEmail.textContent = user?.email ?? "";
    logoutBtn.classList.remove("hide");

    await loadDevices();
    const first = deviceSelect.value;
    if (first) {
      await loadHistory(first);
      startAuto(first);
    }
  }

  async function showLogin(defaultView = "login") {
    dash.classList.add("hide");
    loginCard.classList.remove("hide");
    userEmail.textContent = "";
    logoutBtn.classList.add("hide");
    stopAuto();
    setAuthView(defaultView);
  }

  // Detecta si vienes del email de recuperación (Supabase agrega #type=recovery)
  if (location.hash.includes("type=recovery")) {
    showLogin("recovery");
  } else {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) showApp(); else showLogin("login");
  }

  // ======= Eventos Auth =======
  loginBtn.onclick = async () => {
    loginErr.textContent = "";
    const email = emailEl.value.trim();
    const { error } = await supabase.auth.signInWithPassword({
      email, password: passEl.value.trim()
    });
    if (error) {
      const msg = (error.message || "").toLowerCase();
      if (msg.includes("confirm") || msg.includes("not confirmed")) {
        lastSignupEmail = email;
        checkEmail.textContent = lastSignupEmail;
        setAuthView("check");
        loginErr.textContent = "Tu cuenta aún no está confirmada. Revisa tu bandeja o reenvía el correo.";
        loginErr.className = "error";
      } else {
        loginErr.textContent = "Error: " + error.message;
        loginErr.className = "error";
      }
      return;
    }
    showApp();
  };

  signupBtn.onclick = async () => {
    loginErr.textContent = "";
    const email = suEmail.value.trim();
    const p1 = suPass1.value.trim();
    const p2 = suPass2.value.trim();
    if (!email || !p1) { loginErr.textContent = "Completa email y contraseña"; loginErr.className="error"; return; }
    if (p1 !== p2) { loginErr.textContent = "Las contraseñas no coinciden"; loginErr.className="error"; return; }

    const { error } = await supabase.auth.signUp({
      email, password: p1, options: { emailRedirectTo: REDIRECT_TO }
    });
    if (error) {
      loginErr.textContent = "Error: " + error.message;
      loginErr.className = "error";
      return;
    }
    // Vista amable de verificación
    lastSignupEmail = email;
    checkEmail.textContent = email;
    setAuthView("check");
    loginErr.textContent = "Te enviamos un correo de confirmación. En cuanto lo aceptes, podrás iniciar sesión y ver tus dispositivos.";
    loginErr.className = "success";
  };

  resendBtn.onclick = async () => {
    loginErr.textContent = "";
    const email = rsEmail.value.trim();
    if (!email) { loginErr.textContent = "Ingresa tu email"; loginErr.className="error"; return; }
    const { error } = await supabase.auth.resend({
      type: "signup",
      email,
      options: { emailRedirectTo: REDIRECT_TO }
    });
    if (error) {
      loginErr.textContent = "Error: " + error.message;
      loginErr.className = "error";
      return;
    }
    lastSignupEmail = email;
    checkEmail.textContent = email;
    setAuthView("check");
    loginErr.textContent = "Correo de confirmación reenviado. Revisa tu bandeja.";
    loginErr.className = "success";
  };

  forgotBtn.onclick = async () => {
    loginErr.textContent = "";
    const email = fgEmail.value.trim();
    if (!email) { loginErr.textContent = "Ingresa tu email"; loginErr.className="error"; return; }
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: REDIRECT_TO
    });
    if (error) {
      loginErr.textContent = "Error: " + error.message;
      loginErr.className = "error";
      return;
    }
    loginErr.textContent = "Te enviamos un correo para restablecer la contraseña.";
    loginErr.className = "success";
    setAuthView("login");
  };

  recoveryBtn.onclick = async () => {
    loginErr.textContent = "";
    const p1 = rcPass1.value.trim();
    const p2 = rcPass2.value.trim();
    if (!p1) { loginErr.textContent = "Ingresa la nueva contraseña"; loginErr.className="error"; return; }
    if (p1 !== p2) { loginErr.textContent = "Las contraseñas no coinciden"; loginErr.className="error"; return; }
    const { error } = await supabase.auth.updateUser({ password: p1 });
    if (error) {
      loginErr.textContent = "Error: " + error.message;
      loginErr.className = "error";
      return;
    }
    loginErr.textContent = "Contraseña actualizada. Ya puedes iniciar sesión.";
    loginErr.className = "success";
    history.replaceState(null, "", location.pathname);
    setAuthView("login");
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    stopAuto();
    showLogin("login");
  };

  // ======= Eventos de datos =======
  deviceSelect.onchange = async () => {
    const id = deviceSelect.value;
    if (!id) { stopAuto(); return; }
    stopAuto();
    await loadHistory(id);
    startAuto(id);
  };

  refreshBtn.onclick = async () => {
    const id = deviceSelect.value;
    if (!id) return;
    stopAuto();
    await loadHistory(id);
    startAuto(id);
  };
  rangeSelect.onchange = refreshBtn.onclick;
</script>
</body>
</html>
